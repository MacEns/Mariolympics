@page "/tournament"
@inject PersonRepository PersonRepository

<PageTitle>Mariolympics</PageTitle>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1>Tournament</h1>

    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-sm btn-outline-primary" @onclick="GenerateTournament">Generate Tournament</button>
    </div>

    <!--
        Randomize order of persons for draft
        Select character for each person
        Randomize order of players for each game
        Generate tournament brackets
    -->
</div>

<TournamentBracket Bracket="Tournament?.Brackets.FirstOrDefault()" />

@code {
    private List<Tournament> Tournaments { get; set; }
    private List<Person> Persons { get; set; }

    private Tournament Tournament { get; set; }
    private List<Player> Players { get; set; } = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Persons = await PersonRepository.GetPersonsAsync();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private void GenerateTournament()
    {
        var players = Persons
            .Select(x => new Player { Person = x, CharacterName = Character.All[Persons.IndexOf(x)].ToString() })
            .ToList();
        var bracket = GenerateBracket(players);

        Console.WriteLine("Tournament Bracket:");
        foreach (var round in bracket.Rounds)
        {
            Console.WriteLine($"Round {bracket.Rounds.ToList().IndexOf(round)}:");
            foreach (var match in round.Matches)
            {
                Console.WriteLine($"  {match.Player1?.Person.FullName} vs {match.Player2?.Person.FullName}");
            }
        }

        Tournament = new();
        Tournament.Brackets.Add(bracket);
    }

    private static Bracket GenerateBracket(List<Player> players)
    {
        var totalPlayers = players.Count;
        var nextPowerOfTwo = 1;
        while (nextPowerOfTwo < totalPlayers)
        {
            nextPowerOfTwo *= 2;
        }

        var byes = nextPowerOfTwo - totalPlayers;
        List<Player> firstRound = new List<Player>(players);

        // Add byes as null
        for (int i = 0; i < byes; i++)
        {
            firstRound.Add(null);
        }

        // Shuffle players (optional)
        Random rng = new Random();
        for (int i = firstRound.Count - 1; i > 0; i--)
        {
            int swapIndex = rng.Next(i + 1);
            (firstRound[i], firstRound[swapIndex]) = (firstRound[swapIndex], firstRound[i]);
        }

        // Create the bracket
        var bracket = new Bracket
        {
            Game = "Tournament Game",
            Rounds = new List<Round>()
        };

        int roundNumber = 1;
        List<(Player, Player)> matches = new List<(Player, Player)>();

        for (int i = 0; i < firstRound.Count; i += 2)
        {
            matches.Add((firstRound[i], firstRound[i + 1]));
        }

        bracket.Rounds.Add(new Round
        {
            RoundNumber = roundNumber,
            Matches = matches.Select(m => new Match
            {
                Player1 = m.Item1,
                Player2 = m.Item2
            }).ToList()
        });

        // Generate subsequent rounds
        while (matches.Count > 1)
        {
            roundNumber++;
            List<(Player, Player)> nextRound = new List<(Player, Player)>();
            for (int i = 0; i < matches.Count; i += 2)
            {
                nextRound.Add((null, null)); // Placeholder for winners
            }

            matches = nextRound;
            bracket.Rounds.Add(new Round
            {
                RoundNumber = roundNumber,
                Matches = matches.Select(m => new Match
                {
                    Player1 = m.Item1,
                    Player2 = m.Item2,
                }).ToList()
            });
        }

        // Add third-place game
        if (roundNumber > 1)
        {
            var semifinalLosers = new List<Player>
            {
                null, // Placeholder for the first semifinal loser
                null  // Placeholder for the second semifinal loser
            };

            roundNumber++;
            bracket.Rounds.Add(new Round
            {
                RoundNumber = roundNumber,
                Matches = new List<Match>
                {
                    new Match
                    {
                        Player1 = semifinalLosers[0],
                        Player2 = semifinalLosers[1],
                    }
                }
            });
        }

        return bracket;
    }
}
