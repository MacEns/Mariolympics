@page "/tournament/{TournamentId?}"
@inject PersonRepository PersonRepository
@inject TournamentRepository TournamentRepository
@implements IDisposable

<PageTitle>Mariolympics</PageTitle>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1>Tournament</h1>

    <div class="btn-toolbar mb-2 mb-md-0">
        @if (!IsSelectingPlayers && !IsSelectingCharacters && Tournament == null)
        {
            <button class="btn btn-sm btn-primary" @onclick="StartPlayerSelection">
                New Tournament
            </button>
        }
        else if (IsSelectingPlayers)
        {
            <button class="btn btn-sm btn-success" @onclick="StartCharacterSelection" disabled="@(SelectedPersons.Count < 2)">
                Continue to Character Selection (@SelectedPersons.Count selected)
            </button>
        }
        else if (Tournament != null)
        {
            <button class="btn btn-sm btn-outline-info me-2" @onclick="ToggleLeaderboard">
                @if (showLeaderboard)
                {
                    <span>üèÜ Hide Leaderboard</span>
                }
                else
                {
                    <span>üèÜ Show Leaderboard</span>
                }
            </button>
            <button class="btn btn-sm btn-success" @onclick="SaveTournament" disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <span>üíæ Save Tournament</span>
                }
            </button>
            @if (!string.IsNullOrWhiteSpace(saveMessage))
            {
                <span class="ms-2 @(saveSuccess ? "text-success" : "text-danger")">@saveMessage</span>
            }
        }
    </div>
</div>

@if (IsSelectingPlayers)
{
    <PlayerSelection AllPersons="Persons" SelectedPersons="SelectedPersons" OnSelectionChanged="HandleSelectionChanged" OnPersonAdded="HandlePersonAdded" />
}

@if (IsSelectingCharacters)
{
    <div class="character-selection-container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3>Character Selection</h3>
                <div class="player-slot-machine">
                    <p class="mb-0">@DisplayedPlayerName, choose your character!</p>
                </div>
            </div>
            <div class="card-body">
                <div class="character-grid-3x3">
                    @{
                        var allCharacters = Character.All;
                        var selectedCharacter = temporarySelectedCharacter;
                    }
                    @for (int i = 0; i < 9; i++)
                    {
                        @if (i == 4)
                        {
                            <!-- Confirm button in center (position 4) -->
                            <div class="character-card-wrapper center-confirm">
                                <button class="btn btn-success confirm-character-btn" 
                                        @onclick="ConfirmCharacterSelection" 
                                        disabled="@(temporarySelectedCharacter == null || isAnimating)">
                                    <div class="confirm-content">
                                        @if (temporarySelectedCharacter != null)
                                        {
                                            <img src="@GetCharacterImagePath(temporarySelectedCharacter)" alt="@temporarySelectedCharacter.Value" class="confirm-character-image" />
                                        }
                                        else
                                        {
                                            <span class="confirm-icon">‚úì</span>
                                        }
                                        <div class="confirm-text">@(temporarySelectedCharacter != null ? "Confirm" : "Select")</div>
                                    </div>
                                </button>
                            </div>
                        }
                        else
                        {
                            // Map grid positions to character indices (skip center position)
                            int charIndex = i < 4 ? i : i - 1;
                            if (charIndex < allCharacters.Count)
                            {
                                var character = allCharacters[charIndex];
                                bool isAvailable = AvailableCharacters.Any(c => c.Value == character.Value);
                                bool isSelected = temporarySelectedCharacter?.Value == character.Value;
                                
                                <div class="character-card-wrapper">
                                    <button class="btn character-card @(isAvailable ? "available" : "unavailable") @(isSelected ? "selected" : "")" 
                                            @onclick="() => SelectCharacterTemporary(character)"
                                            disabled="@(!isAvailable || isAnimating)">
                                        <img src="@GetCharacterImagePath(character)" alt="@character.Value" class="character-image" />
                                        <div class="character-name">@character.Value</div>
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="character-card-wrapper empty"></div>
                            }
                        }
                    }
                </div>
            </div>
        </div>
        
        @if (SelectedPlayers.Any())
        {
            <div class="card mt-3">
                <div class="card-header">
                    <h4>Selected Characters</h4>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        @foreach (var player in SelectedPlayers)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <img src="@GetCharacterImagePathByName(player.CharacterName)" alt="@player.CharacterName" class="selected-character-image me-2" />
                                    <span>@player.Person.FullName</span>
                                </div>
                                <span class="badge bg-primary rounded-pill">@player.CharacterName</span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }
    </div>
}

@if (Tournament?.Brackets != null && Tournament.Brackets.Any())
{
    <!-- Leaderboard Card -->
    @if (showLeaderboard)
    {
        <div class="leaderboard-card mt-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">üèÜ Leaderboard</h3>
                </div>
                <div class="card-body">
                    @{
                        var leaderboard = Tournament.GetLeaderboard();
                    }
                @if (leaderboard.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Total Score</th>
                                    @foreach (var bracket in Tournament.Brackets)
                                    {
                                        <th>@bracket.Game</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int rank = 1;
                                    int? lastScore = null;
                                    int displayRank = 1;
                                }
                                @foreach (var (player, totalScore) in leaderboard)
                                {
                                    if (lastScore.HasValue && totalScore != lastScore.Value)
                                    {
                                        displayRank = rank;
                                    }
                                    lastScore = totalScore;
                                    
                                    <tr class="@(displayRank <= 3 ? $"table-{GetRankClass(displayRank)}" : "")">
                                        <td>
                                            <strong>
                                                @if (displayRank == 1) { <span>ü•á</span> }
                                                else if (displayRank == 2) { <span>ü•à</span> }
                                                else if (displayRank == 3) { <span>ü•â</span> }
                                                else { <span>@displayRank</span> }
                                            </strong>
                                        </td>
                                        <td><strong>@player.Person.FullName</strong></td>
                                        <td><strong>@totalScore</strong></td>
                                        @foreach (var bracket in Tournament.Brackets)
                                        {
                                            var bracketScores = Tournament.CalculateBracketScores(bracket);
                                            var playerBracketScore = bracketScores.FirstOrDefault(bs => bs.Player == player);
                                            <td>
                                                @if (playerBracketScore != null)
                                                {
                                                    <span class="badge bg-secondary">
                                                        @GetPlacementText(playerBracketScore.Place) (@playerBracketScore.Points pts)
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        }
                                    </tr>
                                    rank++;
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted mb-0">Complete matches to see the leaderboard</p>
                }
            </div>
        </div>
        </div>
    }
    
    <div class="brackets-container mt-4">
        <ul class="nav nav-tabs" role="tablist">
            @foreach (var bracket in Tournament.Brackets)
            {
                var isActive = Tournament.Brackets.IndexOf(bracket) == 0;
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(isActive ? "active" : "")" 
                            id="@($"tab-{bracket.Game}")" 
                            data-bs-toggle="tab" 
                            data-bs-target="@($"#bracket-{bracket.Game}")" 
                            type="button" 
                            role="tab">
                        @bracket.Game
                    </button>
                </li>
            }
        </ul>
        
        <div class="tab-content mt-3">
            @foreach (var bracket in Tournament.Brackets)
            {
                var isActive = Tournament.Brackets.IndexOf(bracket) == 0;
                <div class="tab-pane fade @(isActive ? "show active" : "")" 
                     id="@($"bracket-{bracket.Game}")" 
                     role="tabpanel">
                    <TournamentBracket Bracket="bracket" />
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public string TournamentId { get; set; }
    private List<Tournament> Tournaments { get; set; }
    private List<Person> Persons { get; set; }

    private Tournament Tournament { get; set; }
    private List<Player> Players { get; set; } = [];
    
    // Player selection state
    private bool IsSelectingPlayers { get; set; }
    private List<Person> SelectedPersons { get; set; } = [];
    
    // Character selection state
    private bool IsSelectingCharacters { get; set; }
    private List<Person> SelectionOrder { get; set; } = [];
    private int CurrentSelectionIndex { get; set; }
    private Person CurrentSelectionPerson => SelectionOrder.ElementAtOrDefault(CurrentSelectionIndex);
    private List<Character> AvailableCharacters { get; set; } = [];
    private List<Player> SelectedPlayers { get; set; } = [];
    private Character temporarySelectedCharacter = null;
    
    // Slot machine animation state
    private string DisplayedPlayerName { get; set; } = "";
    private System.Threading.Timer slotTimer;
    private bool isAnimating = false;
    
    // Save tournament state
    private bool isSaving = false;
    private string saveMessage = "";
    private bool saveSuccess = false;
    
    // Leaderboard state
    private bool showLeaderboard = false;

    private bool debugPrint = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Persons = await PersonRepository.GetPersonsAsync();
            
            // Load tournament if ID is provided in URL
            if (int.TryParse(TournamentId, out int tournamentId) && tournamentId > 0)
            {
                await LoadTournament(tournamentId);
            }
        }

        await base.OnAfterRenderAsync(firstRender);
    }
    
    private async Task LoadTournament(int id)
    {
        try
        {
            Tournament = await TournamentRepository.GetTournamentByIdAsync(id);
            
            if (Tournament != null)
            {
                // Set up round references for all matches
                foreach (var bracket in Tournament.Brackets)
                {
                    foreach (var round in bracket.Rounds)
                    {
                        foreach (var match in round.Matches)
                        {
                            match.Round = round;
                        }
                    }
                    
                    // Set up bronze medal match reference if it exists
                    if (bracket.BronzeMedalMatch != null)
                    {
                        // Bronze medal match doesn't have a round in the normal rounds list
                        // but we can create a temporary round reference for it
                        bracket.BronzeMedalMatch.Round = new Round { RoundNumber = bracket.Rounds.Count + 1 };
                    }
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tournament: {ex.Message}");
        }
    }
    
    private void StartPlayerSelection()
    {
        IsSelectingPlayers = true;
        SelectedPersons.Clear();
        StateHasChanged();
    }
    
    private Task HandleSelectionChanged(List<Person> selectedPersons)
    {
        SelectedPersons = selectedPersons;
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private async Task HandlePersonAdded()
    {
        // Reload persons from database to get the updated list with IDs
        Persons = await PersonRepository.GetPersonsAsync();
        StateHasChanged();
    }
    
    private void StartCharacterSelection()
    {
        if (SelectedPersons == null || SelectedPersons.Count < 2)
        {
            return;
        }
        
        // Move to character selection phase
        IsSelectingPlayers = false;
        IsSelectingCharacters = true;
        SelectedPlayers.Clear();
        CurrentSelectionIndex = 0;
        
        // Randomize the selection order using the selected persons
        var random = new Random();
        SelectionOrder = SelectedPersons.OrderBy(x => random.Next()).ToList();
        
        // Reset available characters
        AvailableCharacters = new List<Character>(Character.All);
        temporarySelectedCharacter = null;
        
        // Start slot machine animation
        StartSlotAnimation();
        
        StateHasChanged();
    }
    
    private void SelectCharacterTemporary(Character character)
    {
        if (character == null || isAnimating || !AvailableCharacters.Any(c => c.Value == character.Value))
        {
            return;
        }
        
        temporarySelectedCharacter = character;
        StateHasChanged();
    }
    
    private void ConfirmCharacterSelection()
    {
        if (CurrentSelectionPerson == null || temporarySelectedCharacter == null || isAnimating)
        {
            return;
        }
        
        // Create player with selected character
        var player = new Player
        {
            Person = CurrentSelectionPerson,
            CharacterName = temporarySelectedCharacter.Value
        };
        
        SelectedPlayers.Add(player);
        // Remove by value comparison
        var toRemove = AvailableCharacters.FirstOrDefault(c => c.Value == temporarySelectedCharacter.Value);
        if (toRemove != null)
        {
            AvailableCharacters.Remove(toRemove);
        }
        temporarySelectedCharacter = null;
        CurrentSelectionIndex++;
        
        // Check if selection is complete
        if (CurrentSelectionIndex >= SelectionOrder.Count)
        {
            IsSelectingCharacters = false;
            StopSlotAnimation();
            GenerateTournament();
        }
        else
        {
            // Start slot animation for next player
            StartSlotAnimation();
        }
        
        StateHasChanged();
    }
    
    private void SelectCharacter(Character character)
    {
        if (CurrentSelectionPerson == null || character == null || isAnimating)
        {
            return;
        }
        
        // Create player with selected character
        var player = new Player
        {
            Person = CurrentSelectionPerson,
            CharacterName = character.Value
        };
        
        SelectedPlayers.Add(player);
        AvailableCharacters.Remove(character);
        CurrentSelectionIndex++;
        
        // Check if selection is complete
        if (CurrentSelectionIndex >= SelectionOrder.Count)
        {
            IsSelectingCharacters = false;
            StopSlotAnimation();
            GenerateTournament();
        }
        else
        {
            // Start slot animation for next player
            StartSlotAnimation();
        }
        
        StateHasChanged();
    }

    private void GenerateTournament()
    {
        // Use the players from character selection
        var players = SelectedPlayers.ToList();
        
        // Generate tournament using the Tournament model
        Tournament = Tournament.Generate(players);

        if (debugPrint)
        {
            Console.WriteLine("Tournament Brackets Generated:");
            foreach (var bracket in Tournament.Brackets)
            {
                Console.WriteLine($"\n{bracket.Game}:");
                foreach (var round in bracket.Rounds)
                {
                    Console.WriteLine($"  Round {bracket.Rounds.ToList().IndexOf(round)}:");
                    foreach (var match in round.Matches)
                    {
                        Console.WriteLine($"    {match.Player1?.Person.FullName} vs {match.Player2?.Person.FullName}");
                    }
                }
            }
        }
        
        StateHasChanged();
    }
    private string GetCharacterImagePath(Character character) => $"/images/{character.Value.ToLower()}.png";
    private string GetCharacterImagePathByName(string characterName) => $"/images/{characterName.ToLower()}.png";
    
    private async Task SaveTournament()
    {
        try
        {
            isSaving = true;
            saveMessage = "";
            StateHasChanged();
            
            if (Tournament.Id == 0)
            {
                // New tournament - add to database
                await TournamentRepository.AddTournamentAsync(Tournament);
                saveMessage = "Tournament saved successfully!";
            }
            else
            {
                // Existing tournament - update
                await TournamentRepository.UpdateTournamentAsync(Tournament);
                saveMessage = "Tournament updated successfully!";
            }
            
            saveSuccess = true;
            
            // Clear message after a delay
            await Task.Delay(3000);
            saveMessage = "";
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving tournament: {ex.Message}";
            saveSuccess = false;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void StartSlotAnimation()
    {
        isAnimating = true;
        int spinCount = 0;
        var random = new Random();
        
        // Get only the players who haven't picked yet (from current index onwards)
        var remainingPlayers = SelectionOrder.Skip(CurrentSelectionIndex).ToList();
        
        // If no remaining players, don't animate
        if (!remainingPlayers.Any())
        {
            isAnimating = false;
            return;
        }
        
        // Spin through names quickly, then slow down
        slotTimer = new System.Threading.Timer(async _ =>
        {
            if (spinCount < 20)
            {
                // Fast spinning - only show remaining players
                var randomPerson = remainingPlayers[random.Next(remainingPlayers.Count)];
                DisplayedPlayerName = randomPerson.FullName;
                spinCount++;
                await InvokeAsync(StateHasChanged);
            }
            else if (spinCount < 30)
            {
                // Slow down - only show remaining players
                var randomPerson = remainingPlayers[random.Next(remainingPlayers.Count)];
                DisplayedPlayerName = randomPerson.FullName;
                spinCount++;
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                // Land on the actual current person
                DisplayedPlayerName = CurrentSelectionPerson?.FullName ?? "";
                isAnimating = false;
                slotTimer?.Dispose();
                await InvokeAsync(StateHasChanged);
            }
        }, null, 0, 100); // Update every 100ms, slow down by changing interval
        
        // Schedule slowdown
        Task.Delay(2000).ContinueWith(_ =>
        {
            slotTimer?.Change(0, 200); // Slow down to 200ms
        });
    }
    
    private void StopSlotAnimation()
    {
        slotTimer?.Dispose();
        slotTimer = null;
        isAnimating = false;
    }
    
    public void Dispose()
    {
        StopSlotAnimation();
    }
    
    private void ToggleLeaderboard()
    {
        showLeaderboard = !showLeaderboard;
    }
    
    private string GetRankClass(int rank)
    {
        return rank switch
        {
            1 => "warning",  // Gold
            2 => "secondary", // Silver
            3 => "danger",   // Bronze
            _ => ""
        };
    }
    
    private string GetPlacementText(int place)
    {
        return place switch
        {
            1 => "1st",
            2 => "2nd",
            3 => "3rd",
            _ => $"{place}th"
        };
    }

}
